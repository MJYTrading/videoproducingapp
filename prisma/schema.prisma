generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../data/video-producer.db"
}

// ─── Auth ───────────────────────────────────────────────

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ─── Settings ───────────────────────────────────────────

model Settings {
  id                    String  @id @default("singleton")
  elevateApiKey         String  @default("")
  n8nBaseUrl            String  @default("https://n8n.srv1275252.hstgr.cloud")
  assemblyAiApiKey      String  @default("")
  discordWebhookUrl     String  @default("")
  discordUserId         String  @default("1154154714699665418")
  openClawUrl           String  @default("http://127.0.0.1:18789")
  openClawHooksToken    String  @default("")
  defaultVoice          String  @default("Brody — Crime Narrator")
  defaultVisualStyle    String  @default("ai-3d-render")
  defaultLanguage       String  @default("EN")
  defaultScriptLength   Int     @default(5000)
  defaultSubtitles      Boolean @default(true)
  defaultColorGrading   String  @default("cinematic_dark")
  youtubeTranscriptApiKey String @default("")
  anthropicApiKey       String  @default("")
  genaiProApiKey        String  @default("")
  genaiProEnabled       Boolean @default(false)
  genaiProImagesEnabled Boolean @default(false)
  videoDownloadApiKey   String  @default("")

  // Extra API keys
  perplexityApiKey      String  @default("")
  twelveLabsApiKey      String  @default("")
  nexlevApiKey          String  @default("")
  youtubeRapidApiKey    String  @default("")
  pexelsApiKey          String  @default("")
}

// ─── Channel ────────────────────────────────────────────

model Channel {
  id            String    @id @default(cuid())
  name          String    @unique
  driveFolderId String    @default("")
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Basis configuratie
  youtubeChannelId    String  @default("")
  defaultVideoType    String  @default("ai")
  competitors         String  @default("[]")

  // Spokesperson configuratie
  maxClipDurationSeconds Int?

  // Style Profile & Research op kanaal-level
  baseStyleProfile       String?
  baseResearchTemplate   String?
  styleReferenceUrls     String  @default("[]")
  styleExtraInstructions String  @default("")

  // Clip historie
  usedClips String @default("[]")

  // Media presets
  overlayPresetId       String?
  sfxEnabled            Boolean @default(true)
  specialEditsEnabled   Boolean @default(true)

  // Pipeline v2 presets
  sfxLevel              String  @default("medium")
  motionGraphicsLevel   String  @default("medium")

  // Standaard project instellingen
  defaultScriptLengthMinutes Float    @default(8)
  defaultVoiceId             String   @default("")
  defaultOutputFormat        String   @default("youtube-1080p")
  defaultAspectRatio         String   @default("landscape")
  defaultSubtitles           Boolean  @default(true)
  defaultLanguage            String   @default("EN")
  defaultVisualStyle         String   @default("ai-3d-render")
  defaultVisualStyleParent   String?  @default("ai")
  referenceScriptUrls        String   @default("[]")

  // Analytics
  rpm                        Float    @default(0)

  // Relaties
  projects              Project[]
  ideas                 Idea[]
  competitorEntries     Competitor[]
  musicSelections       ChannelMusicSelection[]
  sfxSelections         ChannelSfxSelection[]
  specialEditSelections ChannelSpecialEditSelection[]
  editingKnowledge      EditingKnowledge[]
  overlayPreset         OverlayPreset? @relation(fields: [overlayPresetId], references: [id])
  viewSnapshots         ChannelViewSnapshot[]
}

// ─── Channel View Snapshots ─────────────────────────────

model ChannelViewSnapshot {
  id            String   @id @default(cuid())
  channelId     String
  hour          DateTime
  totalViews    Int      @default(0)
  viewsInHour   Int      @default(0)
  createdAt     DateTime @default(now())

  channel       Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, hour])
  @@index([channelId])
  @@index([hour])
}

// ─── Video View Snapshots ───────────────────────────────

model VideoViewSnapshot {
  id            String   @id @default(cuid())
  channelId     String
  videoId       String
  title         String   @default("")
  hour          DateTime
  viewCount     Int      @default(0)
  viewsGained   Int      @default(0)
  publishDate   String   @default("")
  createdAt     DateTime @default(now())

  @@unique([channelId, videoId, hour])
  @@index([channelId, hour])
  @@index([videoId])
}

// ─── Project ────────────────────────────────────────────

model Project {
  id                  String    @id @default(cuid())
  name                String
  title               String
  description         String?
  language            String    @default("EN")
  scriptSource        String    @default("new")
  referenceVideos     String    @default("[]")
  scriptLength        Int?
  scriptUrl           String?
  voice               String
  backgroundMusic     Boolean   @default(false)
  visualStyle         String
  visualStyleParent   String?
  customVisualStyle   String?
  imageSelectionMode  String    @default("auto")
  imagesPerScene      Int       @default(1)
  selectedImages      String    @default("[]")
  transitionMode      String    @default("none")
  uniformTransition   String?
  sceneTransitions    String    @default("[]")
  useClips            Boolean   @default(false)
  referenceClips      String    @default("[]")
  montageClips        String    @default("[]")
  stockImages         Boolean   @default(false)
  checkpoints         String    @default("[]")
  feedbackHistory     String    @default("[]")
  colorGrading        String    @default("Geen")
  subtitles           Boolean   @default(true)
  output              String    @default("YouTube 1080p")
  status              String    @default("config")
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  aspectRatio         String    @default("landscape")
  priority            Int       @default(0)
  queuePosition       Int?
  enabledSteps        String    @default("[]")
  channelId           String?
  driveUrl            String?

  videoType           String    @default("ai")
  subtitleStyle       String    @default("classic")

  // v3: Pipeline reference
  pipelineId          String?

  channel             Channel?  @relation(fields: [channelId], references: [id])
  steps               Step[]
  logs                LogEntry[]
}

// ─── Pipeline Steps (per project run) ──────────────────

model Step {
  id             String    @id @default(cuid())
  stepNumber     Int
  name           String
  executor       String
  status         String    @default("waiting")
  duration       Int?
  error          String?
  retryCount     Int       @default(0)
  startedAt      DateTime?
  firstAttemptAt DateTime?
  result         String?
  aiResponse     String?
  attemptNumber  Int       @default(1)
  metadata       String?
  projectId      String
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  @@unique([projectId, stepNumber])
}

model LogEntry {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  level     String
  step      Int
  source    String
  message   String
  detail    String?
  durationMs Int?
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, step])
  @@index([projectId, timestamp])
}

// ─── Voices ─────────────────────────────────────────────

model Voice {
  id          String   @id @default(cuid())
  name        String
  voiceId     String   @unique
  description String
  language    String
  createdAt   DateTime @default(now())
}

// ─── Ideation ───────────────────────────────────────────

model Idea {
  id              String   @id @default(cuid())
  title           String
  description     String
  videoType       String
  channelId       String
  sourceData      String   @default("{}")
  referenceVideos String   @default("[]")
  status          String   @default("saved")
  projectId       String?
  createdAt       DateTime @default(now())

  channel         Channel  @relation(fields: [channelId], references: [id])
}

// ─── Research Templates ─────────────────────────────────

model ResearchTemplate {
  id          String   @id @default(cuid())
  name        String
  videoType   String
  template    String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ─── NexLev Data Cache ──────────────────────────────────

model NexLevCache {
  id          String   @id @default(cuid())
  channelId   String
  endpoint    String
  data        String
  fetchedAt   DateTime @default(now())

  @@unique([channelId, endpoint])
  @@index([channelId])
}

// ─── Competitors ────────────────────────────────────────

model Competitor {
  id              String   @id @default(cuid())
  channelId       String
  ytChannelId     String
  name            String   @default("")
  notes           String   @default("")
  cachedAbout     String?
  createdAt       DateTime @default(now())

  channel         Channel  @relation(fields: [channelId], references: [id])

  @@unique([channelId, ytChannelId])
  @@index([channelId])
}

// ─── Clip Library ───────────────────────────────────────

model AssetClip {
  id            String    @id @default(cuid())
  reviewStatus  String    @default("pending")
  sourceUrl     String
  videoId       String
  title         String
  startTime     String
  endTime       String
  localPath     String
  thumbnailPath String?
  tags          String    @default("[]")
  description   String
  category      String
  subjects      String    @default("[]")
  mood          String?
  quality       Float?
  timesUsed     Int       @default(0)
  lastUsedAt    DateTime?
  createdAt     DateTime  @default(now())
}

// ─── Music Library ──────────────────────────────────────

model MusicTrack {
  id              String   @id @default(cuid())
  title           String
  filePath        String
  duration        Float
  mood            String   @default("[]")
  genre           String
  bpm             Int?
  energyProfile   String?
  hasVocals       Boolean  @default(false)
  loopable        Boolean  @default(false)
  tags            String   @default("[]")
  createdAt       DateTime @default(now())

  channelSelections ChannelMusicSelection[]
}

model ChannelMusicSelection {
  id           String @id @default(cuid())
  channelId    String
  musicTrackId String

  channel      Channel    @relation(fields: [channelId], references: [id], onDelete: Cascade)
  musicTrack   MusicTrack @relation(fields: [musicTrackId], references: [id], onDelete: Cascade)

  @@unique([channelId, musicTrackId])
}

// ─── Overlay Library ────────────────────────────────────

model OverlayFile {
  id          String   @id @default(cuid())
  name        String
  filePath    String
  resolution  String?
  framerate   Int?
  duration    Float?
  category    String
  tags        String   @default("[]")
  previewUrl  String?
  createdAt   DateTime @default(now())
}

model OverlayPreset {
  id          String   @id @default(cuid())
  name        String
  description String?
  layers      String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  channels    Channel[]
}

// ─── Sound Effects Library ──────────────────────────────

model SoundEffect {
  id          String   @id @default(cuid())
  name        String
  filePath    String
  duration    Float
  category    String
  intensity   String   @default("medium")
  tags        String   @default("[]")
  usageGuide  String?
  createdAt   DateTime @default(now())

  channelSelections ChannelSfxSelection[]
}

model SfxUsageRule {
  id               String   @id @default(cuid())
  name             String
  description      String
  sfxCategory      String
  triggerCondition String
  isDefault        Boolean  @default(false)
  createdAt        DateTime @default(now())
}

model ChannelSfxSelection {
  id            String @id @default(cuid())
  channelId     String
  soundEffectId String

  channel       Channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  soundEffect   SoundEffect @relation(fields: [soundEffectId], references: [id], onDelete: Cascade)

  @@unique([channelId, soundEffectId])
}

// ─── Special Edits Library ──────────────────────────────

model SpecialEdit {
  id            String   @id @default(cuid())
  name          String
  description   String
  scriptPath    String
  parameters    String   @default("{}")
  applicableFor String   @default("[]")
  usageGuide    String?
  previewUrl    String?
  createdAt     DateTime @default(now())

  channelSelections ChannelSpecialEditSelection[]
}

model ChannelSpecialEditSelection {
  id            String @id @default(cuid())
  channelId     String
  specialEditId String

  channel       Channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  specialEdit   SpecialEdit @relation(fields: [specialEditId], references: [id], onDelete: Cascade)

  @@unique([channelId, specialEditId])
}

// ─── Editing Knowledge ──────────────────────────────────

model EditingKnowledge {
  id            String   @id @default(cuid())
  projectId     String
  videoType     String
  channelId     String
  directorsCut  String
  userFeedback  String?
  effectsUsed   String   @default("[]")
  score         Int?
  createdAt     DateTime @default(now())

  channel       Channel  @relation(fields: [channelId], references: [id])
}

// ─── Asset Images Library ───────────────────────────────

model AssetImage {
  id            String    @id @default(cuid())
  reviewStatus  String    @default("pending")
  sourceUrl     String
  localPath     String
  thumbnailPath String?
  title         String
  description   String    @default("")
  tags          String    @default("[]")
  category      String    @default("general")
  subjects      String    @default("[]")
  mood          String?
  style         String?
  source        String    @default("pipeline")
  width         Int?
  height        Int?
  fileSize      Int?
  quality       Float?
  timesUsed     Int       @default(0)
  lastUsedAt    DateTime?
  projectId     String?
  createdAt     DateTime  @default(now())
}

// ═══════════════════════════════════════════════════════════
// PIPELINE BUILDER v3 — Visuele Pipeline Builder
// ═══════════════════════════════════════════════════════════

// ─── LLM Modellen ───────────────────────────────────────

model LlmModel {
  id              Int       @id @default(autoincrement())
  name            String
  provider        String
  modelString     String
  modelType       String    @default("chat")
  baseUrl         String    @default("")
  supportsStream  Boolean   @default(true)
  maxTokens       Int?
  costPerMToken   Float?
  rateLimit       String?
  isActive        Boolean   @default(true)
  notes           String    @default("")
  createdAt       DateTime  @default(now())

  // Relations (v2 legacy + v3)
  pipelineSteps   PipelineStep[]
  stepDefinitions StepDefinition[]
  pipelineNodes   PipelineNode[]
}

// ─── API Tools ──────────────────────────────────────────

model ApiTool {
  id             Int       @id @default(autoincrement())
  name           String
  category       String    @default("api")
  baseUrl        String    @default("")
  authType       String    @default("bearer")
  authKeyRef     String    @default("")
  healthEndpoint String?
  isActive       Boolean   @default(true)
  lastHealthCheck DateTime?
  lastHealthOk   Boolean?
  lastHealthMs   Int?
  notes          String    @default("")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// ─── API Test Logs ──────────────────────────────────────

model ApiTestLog {
  id           Int       @id @default(autoincrement())
  toolId       Int?
  method       String    @default("GET")
  url          String
  headers      String    @default("{}")
  body         String?
  statusCode   Int?
  response     String?
  durationMs   Int?
  error        String?
  createdAt    DateTime  @default(now())
}

// ─── AI Assistent ───────────────────────────────────────

model AssistantConversation {
  id           String    @id @default(cuid())
  title        String    @default("Nieuw gesprek")
  messages     String    @default("[]")
  context      String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// ─── v2 Legacy: Pipeline Steps (blijft als fallback) ────

model PipelineStep {
  id              Int       @id @default(autoincrement())
  stepNumber      Int       @unique
  name            String
  description     String    @default("")
  executorLabel   String    @default("App")
  executorFn      String    @default("")
  toolPrimary     String    @default("")
  toolFallback    String?
  llmModelId      Int?
  llmModel        LlmModel? @relation(fields: [llmModelId], references: [id])
  systemPrompt    String    @default("")
  userPromptTpl   String    @default("")
  outputFormat    String    @default("")
  temperature     Float     @default(0.7)
  maxTokens       Int?
  dependsOn       String    @default("[]")
  parallelGroup   String?
  isCheckpoint    Boolean   @default(false)
  checkpointCond  String?
  timeout         Int       @default(300000)
  maxRetries      Int       @default(3)
  retryDelays     String    @default("[5000,15000,30000]")
  readyToUse      Boolean   @default(false)
  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)
  notes           String    @default("")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  videoTypeConfigs PipelineVideoTypeConfig[]
}

model PipelineVideoTypeConfig {
  id           Int           @id @default(autoincrement())
  videoType    String
  stepId       Int
  step         PipelineStep  @relation(fields: [stepId], references: [id], onDelete: Cascade)
  enabled      Boolean       @default(true)
  @@unique([videoType, stepId])
}

// ═══════════════════════════════════════════════════════════
// PIPELINE BUILDER v3 — Nieuwe modellen
// ═══════════════════════════════════════════════════════════

// ─── Step Definitions (globale catalogus van atomaire stappen) ──

model StepDefinition {
  id              Int       @id @default(autoincrement())
  name            String                                // "Research JSON"
  slug            String    @unique                     // "research-json"
  category        String    @default("general")         // research | script | audio | visual | post | output
  description     String    @default("")
  executorFn      String    @default("")                // "executeStepResearch"
  executorLabel   String    @default("App")             // "Sonar Deep Research"

  // Tool & LLM defaults
  toolPrimaryId   Int?
  toolFallbackId  Int?
  llmModelId      Int?
  llmModel        LlmModel? @relation(fields: [llmModelId], references: [id])

  // Default prompts & config
  defaultConfig   String    @default("{}")              // JSON: temperature, maxTokens, etc.
  systemPrompt    String    @default("")
  userPromptTpl   String    @default("")
  outputFormat    String    @default("")                // "json" | "text" | "file" | "multi-file"

  // Input/Output schema
  inputSchema     String    @default("[]")              // JSON: [{ key, type, label, required }]
  outputSchema    String    @default("[]")              // JSON: [{ key, type, label, filePath }]

  // Status
  isReady         Boolean   @default(false)             // Is de executor gebouwd?
  isActive        Boolean   @default(true)
  notes           String    @default("")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  pipelineNodes   PipelineNode[]
}

// ─── Pipeline (per video type — eigen configuratie) ─────

model Pipeline {
  id              Int       @id @default(autoincrement())
  name            String                                // "AI Generated Video"
  slug            String    @unique                     // "ai"
  description     String    @default("")
  isDefault       Boolean   @default(false)             // Standaard pipeline voor dit type
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  nodes           PipelineNode[]
  connections     PipelineConnection[]
}

// ─── Pipeline Node (een stap geplaatst in een pipeline) ─

model PipelineNode {
  id                  Int       @id @default(autoincrement())
  pipelineId          Int
  pipeline            Pipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stepDefinitionId    Int
  stepDefinition      StepDefinition @relation(fields: [stepDefinitionId], references: [id])

  // Visuele positie op canvas
  positionX           Float     @default(0)
  positionY           Float     @default(0)
  sortOrder           Int       @default(0)             // Fallback executie volgorde

  // Per-pipeline overrides (overschrijft StepDefinition defaults)
  configOverrides     String    @default("{}")           // JSON: temperature, maxTokens, etc.
  systemPromptOverride String?                           // null = gebruik default
  userPromptOverride   String?                           // null = gebruik default
  llmModelOverrideId   Int?
  llmModelOverride     LlmModel? @relation(fields: [llmModelOverrideId], references: [id])

  // Pipeline execution config
  isActive            Boolean   @default(true)
  isCheckpoint        Boolean   @default(false)
  checkpointCond      String?
  timeout             Int       @default(300000)
  maxRetries          Int       @default(3)
  retryDelays         String    @default("[5000,15000,30000]")

  // Relations
  outgoingConnections PipelineConnection[] @relation("SourceNode")
  incomingConnections PipelineConnection[] @relation("TargetNode")

  @@unique([pipelineId, stepDefinitionId])
  @@index([pipelineId])
}

// ─── Pipeline Connection (draad tussen twee nodes) ──────

model PipelineConnection {
  id              Int       @id @default(autoincrement())
  pipelineId      Int
  pipeline        Pipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  sourceNodeId    Int
  sourceNode      PipelineNode @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  sourceOutputKey String                                // "research_json"

  targetNodeId    Int
  targetNode      PipelineNode @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)
  targetInputKey  String                                // "research_data"

  @@unique([pipelineId, sourceNodeId, sourceOutputKey, targetNodeId, targetInputKey])
  @@index([pipelineId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
}
